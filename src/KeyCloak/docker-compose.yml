version: "3"
services:
  db:
    image: postgres:13.3-alpine
    environment:
      PGDATA: /var/lib/postgresql/data/pgdata
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: db01
    # Un-comment to access the db service directly
    ports:
     - 5432:5432
    networks:
      - base
    restart: unless-stopped
    volumes:
      - dbData:/var/lib/postgresql/data
  keycloak:
    image: quay.io/keycloak/keycloak:14.0.0
    container_name: sampleKeycloak
    environment:
      - DB_VENDOR=postgres
      - DB_USER=postgres
      - DB_PASSWORD=postgres
      - DB_ADDR=db
      - DB_DATABASE=db01
      - KEYCLOAK_USER=admin
      - KEYCLOAK_PASSWORD=admin
      - KEYCLOAK_IMPORT=./realm-export.json
    volumes:
      - ./realm-export.json:/realm-export.json
    depends_on:
      - db
      #- nginx
    networks:
      - base
      - externo
    ports:
      - 8088:8080
      - 9099:9090
  api:
    image: api
    build:
      context: ./../API/
      dockerfile: Dockerfile
    container_name: sampleKeycloakAPI
    environment:
      - ASPNETCORE_ENVIRONMENT=Keycloak
      - BaseAuthUrl=http://192.168.0.143:8088
    depends_on:
      - db
    networks:
      - base
      - externo
    ports:
      - 8081:80
  mvc:
    image: mvc
    build:
      context: ./../MVC/
      dockerfile: Dockerfile
    container_name: sampleKeycloakMVC
    environment:
      - ASPNETCORE_ENVIRONMENT=Keycloak
      - BaseAuthUrl=http://192.168.0.142:8088
    depends_on:
      - api
    networks:
      - externo
    ports:
      - 8085:80
  angular:
    image: angularkeycloak
    build:
      context: ./../angular/
      dockerfile: Dockerfile
    container_name: angularkeycloak
    depends_on:
      - api
    networks:
      - externo
    ports:
      - 4200:80
  nginx:
    image: nginx:1.21.0-alpine
    volumes:
       - ./nginx.conf:/etc/nginx/nginx.conf
       - ./nginxconfig:/etc/nginx/conf.d/
    ports:
       - "80:80"
       - "90:90"
    networks:
      - externo

networks:
  base:
  externo:
volumes:
  dbData:
  dbLog:
  dbSecrets:
