version: "3.4"
services:
  db:
    image: postgres:13.3-alpine
    environment:
      PGDATA: /var/lib/postgresql/data/pgdata
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: db01
    # Un-comment to access the db service directly
    ports:
     - 5432:5432
    networks:
      - base
    restart: unless-stopped
    volumes:
      - dbData:/var/lib/postgresql/data

  cadastro.api:
    image: cadastro.api
    build:
      context: ./../API/
      dockerfile: Dockerfile
    container_name: cadastro.api
    environment:
      - ASPNETCORE_ENVIRONMENT=Keycloak
      - BaseAuthUrl=http://keycloak.localhost
    depends_on:
      - db
    networks:
      - base
      - externo
    ports:
      - 8081:80

  cadastro.mvc:
    image: cadastro.mvc
    build:
      context: ./../MVC/
      dockerfile: Dockerfile
    container_name: cadastro.mvc
    environment:
      - ASPNETCORE_ENVIRONMENT=Keycloak
      - BaseAuthUrl=http://keycloak.localhost
    depends_on:
      - cadastro.api
    networks:
      - externo
    ports:
      - 8085:80

  angular:
    image: angular
    build:
      context: ./../angular/
      dockerfile: Dockerfile
    container_name: angular
    depends_on:
      - cadastro.api
    networks:
      - externo
    ports:
      - 4200:80
  
  # traefik:
  #   image: traefik:v2.5
  #   container_name: traefik
  #   # hostname: "traefik"
  #   ports:
  #     - "80:80"
  #     - "8089:8080"
  #   volumes:
  #     - "/var/run/docker.sock:/var/run/docker.sock:ro"
  #     - "./traefik.yml:/traefik.yml:ro"
  #   networks:
  #     - externo
  #     - externo1
  #   depends_on:
  #     - fusionauth
  #     - cadastro.mvc
  #     - angular      
  #     - cadastro.api      
  #     - keycloak

  fusionauth:
    image: fusionauth/fusionauth-app:1.26.1
    container_name: fusionauth
    depends_on:
      - db
    environment:
        DATABASE_URL: jdbc:postgresql://db:5432/fusionauth
        # Prior to version 1.19.0, use this deprecated name
        # DATABASE_ROOT_USER: ${POSTGRES_USER}
        DATABASE_ROOT_USERNAME: postgres
        DATABASE_ROOT_PASSWORD: postgres
        # Prior to version 1.19.0, use this deprecated name
        # DATABASE_USER: ${DATABASE_USER}
        DATABASE_USERNAME: postgres
        DATABASE_PASSWORD: postgres
        # Prior to version 1.19.0, use this deprecated names
        # FUSIONAUTH_MEMORY: ${FUSIONAUTH_MEMORY}
        # FUSIONAUTH_SEARCH_ENGINE_TYPE: database
        # FUSIONAUTH_URL: http://fusionauth:9011
        # FUSIONAUTH_RUNTIME_MODE: development
        FUSIONAUTH_APP_MEMORY: 512M
        FUSIONAUTH_APP_RUNTIME_MODE: development
        FUSIONAUTH_APP_URL: http://fusionauth:9011
        SEARCH_TYPE: database
    networks:
      - externo
      - base
    restart: unless-stopped
    ports:
      - 91:9011
    volumes:
      - fa_config:/usr/local/fusionauth/config

  keycloak:
    image: quay.io/keycloak/keycloak:14.0.0
    container_name: keycloak
    environment:
      - DB_VENDOR=postgres
      - DB_USER=postgres
      - DB_PASSWORD=postgres
      - DB_ADDR=db
      - DB_DATABASE=db01
      - KEYCLOAK_USER=admin
      - KEYCLOAK_PASSWORD=admin
      - KEYCLOAK_IMPORT=./realm-export.json
    volumes:
      - ./realm-export.json:/realm-export.json
    depends_on:
      - db
      #- nginx
    networks:
      - base
      - externo
    ports:
      - 8088:8080
      - 9099:9090


  nginx:
    image: nginx:1.21.0-alpine
    container_name: nginx
    domainname: localhost
    volumes:
       - ./nginx.conf:/etc/nginx/nginx.conf
       - ./nginxconfig:/etc/nginx/conf.d/
    ports:
       - 80:80
       - 8080:8080
       - 9090:9090
       - 9011:9011
    networks:
      - externo
    depends_on:
      - fusionauth
      - cadastro.mvc
      - angular      
      - cadastro.api      
      - keycloak
    environment: 
      - NGINX_HOST=localhost
      - NGINX_PORT=80  


networks:
  base:
  externo:
volumes:
  dbData:
  dbLog:
  dbSecrets:
  fa_config:
